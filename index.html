<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>奇幻島嶼探險</title>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            font-family: "微軟正黑體", "Microsoft JhengHei", sans-serif;
            overflow: hidden;
            position: fixed;
        }

        /* === 載入動畫 === */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            z-index: 9998;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            font-size: 18px;
            transition: opacity 0.5s ease-out;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid #e6b800;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-text {
            margin-top: 10px;
            font-size: 16px;
            letter-spacing: 2px;
        }

        /* === 語言切換按鈕 === */
        #lang-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: auto;
            z-index: 101;
            cursor: pointer;
            transition: transform 0.3s ease;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.6));
        }

        #lang-switch img {
            width: 100%;
            height: auto;
            display: block;
        }

        #lang-switch:active {
            transform: scale(0.85);
        }

        /* === 片頭動畫 === */
        #scene-intro {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 1.0s ease-out;
        }

        #intro-video {
            width: 100%;
            max-width: 800px;
            height: auto;
            object-fit: contain;
        }

        .fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* === 隱藏類別 === */
        .hidden {
            display: none !important;
        }

        /* === 地圖頁面 === */
        #scene-map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('map.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* === 透明按鈕 (Hotspots) === */
        .hotspot {
            position: absolute;
            cursor: pointer;
            background-color: transparent;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            filter: drop-shadow(0px 0px 8px rgba(255, 255, 255, 0.6));
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .hotspot:active {
            transform: scale(0.9);
        }

        /* === 五個島嶼位置 === */
        #btn-dragon { 
            top: 5%; 
            left: 5%; 
            width: 35%; 
            height: 25%;
            background-image: url('icon_dragon.png');
        }

        #btn-volcano { 
            top: 18%; 
            right: 5%; 
            width: 35%; 
            height: 25%; 
            background-image: url('icon_volcano.png');
        }

        #btn-park { 
            top: 42%; 
            left: 15%; 
            width: 40%; 
            height: 20%; 
            background-image: url('icon_park.png'); 
        }

        #btn-castle { 
            bottom: 25%; 
            right: 0%; 
            width: 30%; 
            height: 20%; 
            background-image: url('icon_castle.png');
        }

        #btn-temple { 
            bottom: 0%; 
            left: 0%; 
            width: 55%; 
            height: 40%; 
            background-image: url('icon_temple.png');
        }

        /* === 呼吸動畫 === */
        @keyframes breathe {
            0% { 
                transform: scale(1); 
                filter: drop-shadow(0px 0px 8px rgba(255, 255, 255, 0.6));
            }
            50% { 
                transform: scale(1.08); 
                filter: drop-shadow(0px 0px 15px rgba(255, 255, 255, 0.9)) brightness(1.15);
            }
            100% { 
                transform: scale(1); 
                filter: drop-shadow(0px 0px 8px rgba(255, 255, 255, 0.6));
            }
        }

        .hotspot {
            animation: breathe 2.5s infinite ease-in-out;
        }

        /* === 影片播放容器 === */
        #scene-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        #video-player {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        /* === 結果頁面 === */
        #scene-result {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 20px;
            box-sizing: border-box;
        }

        #result-bg-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }

        /* === 按鈕容器 === */
        .img-btn-container {
            position: relative;
            z-index: 10;
            display: block;
            width: 70%;
            max-width: 320px;
            margin: 0 auto;
            cursor: pointer;
            background: transparent;
            border: none;
            padding: 0;
            text-align: center;
            transition: transform 0.3s ease;
            text-decoration: none;
        }

        .img-btn-container img {
            width: 100%;
            height: auto;
            display: block;
            filter: drop-shadow(0 6px 8px rgba(0,0,0,0.7));
        }

        .img-btn-container:active {
            transform: scale(0.92);
        }

        /* === 通用按鈕樣式 === */
        .action-btn {
            background-color: rgba(0, 0, 0, 0.75);
            color: #fff;
            border: 2px solid #fff;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 30px;
            font-size: 18px;
            cursor: pointer;
            width: 80%;
            max-width: 300px;
            text-align: center;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .action-btn:active {
            background-color: #fff;
            color: #000;
            transform: scale(0.95);
        }

        .primary-btn {
            background-color: #e6b800;
            color: #000;
            border: none;
            font-weight: bold;
        }

        /* === 手機版優化 === */
        @media (max-width: 768px) {
            #lang-switch {
                width: 45px;
                top: 15px;
                right: 15px;
            }

            .img-btn-container {
                width: 75%;
                max-width: 280px;
            }

            #loading-text {
                font-size: 14px;
            }

            .spinner {
                width: 40px;
                height: 40px;
            }
        }

        /* === iOS Safari 特殊處理 === */
        @supports (-webkit-touch-callout: none) {
            body {
                height: -webkit-fill-available;
            }
        }
    </style>
</head>
<body>
    <!-- 載入畫面 -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">載入中...</div>
    </div>

    <!-- 片頭動畫 -->
    <div id="scene-intro" class="hidden">
        <video id="intro-video" 
               src="intro.mp4" 
               muted 
               playsinline 
               webkit-playsinline
               preload="auto">
        </video>
    </div>

    <!-- 語言切換按鈕 -->
    <div id="lang-switch" onclick="toggleLanguage()">
        <img id="img-lang" src="lang_to_en.png" alt="切換語言">
    </div>

    <!-- 地圖場景 -->
    <div id="scene-map" class="hidden">
        <div class="hotspot" id="btn-park" onclick="playScene('park')"></div>
        <div class="hotspot" id="btn-volcano" onclick="playScene('volcano')"></div>
        <div class="hotspot" id="btn-dragon" onclick="playScene('dragon')"></div>
        <div class="hotspot" id="btn-castle" onclick="playScene('castle')"></div>
        <div class="hotspot" id="btn-temple" onclick="playScene('temple')"></div>
    </div>

    <!-- 過場影片場景 -->
    <div id="scene-video" class="hidden">
        <video id="video-player" 
               playsinline 
               webkit-playsinline
               preload="auto">
        </video>
    </div>

    <!-- 結果頁面 -->
    <div id="scene-result" class="hidden">
        <video id="result-bg-video" 
               loop 
               muted 
               playsinline 
               webkit-playsinline
               preload="auto">
        </video>
        
        <a href="#" id="link-company" class="img-btn-container">
            <img id="img-company" src="btn_company.png" alt="前往公司網頁">
        </a>

        <div onclick="resetMap()" class="img-btn-container">
            <img id="img-back" src="btn_back.png" alt="回到地圖">
        </div>
    </div>

    <!-- 背景音樂 -->
    <audio id="map-bgm" loop preload="auto">
        <source src="bgm.mp3" type="audio/mp3">
    </audio>

    <script>
        // ==================== 設定區 ====================
        const companyUrl = "https://www.google.com"; 

        // ==================== DOM 元素 ====================
        const mapScene = document.getElementById('scene-map');
        const videoScene = document.getElementById('scene-video');
        const resultScene = document.getElementById('scene-result');
        const videoPlayer = document.getElementById('video-player');
        const bgVideo = document.getElementById('result-bg-video');
        const companyLink = document.getElementById('link-company');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const introScene = document.getElementById('scene-intro');
        const introVideo = document.getElementById('intro-video');

        // 設定公司連結
        companyLink.href = companyUrl;

        // ==================== 全域變數 ====================
        let currentIsland = '';
        let isTransitioning = false;
        let currentLang = 'cn';
        let bgmPlayed = false;

        // ==================== 初始化 ====================
        window.addEventListener('load', function() {
            setTimeout(() => {
                initApp();
            }, 300);
        });

        function initApp() {
            console.log('App 初始化中...');
            
            // 顯示片頭
            introScene.classList.remove('hidden');
            
            // 片頭影片結束監聽
            introVideo.addEventListener('ended', function() {
                console.log('片頭播放完畢');
                introScene.classList.add('fade-out');
                setTimeout(() => {
                    introScene.style.display = 'none';
                    showMap();
                }, 1000);
            });

            // 嘗試自動播放片頭
            const playPromise = introVideo.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('片頭自動播放成功');
                    loadingOverlay.classList.add('hidden');
                }).catch(error => {
                    console.log('片頭需要用戶互動才能播放:', error);
                    // 顯示提示讓用戶點擊
                    loadingText.textContent = '點擊畫面開始';
                    loadingOverlay.style.cursor = 'pointer';
                    
                    loadingOverlay.addEventListener('click', function() {
                        introVideo.play().then(() => {
                            loadingOverlay.classList.add('hidden');
                        }).catch(e => {
                            console.error('播放失敗，直接進入地圖', e);
                            introScene.style.display = 'none';
                            loadingOverlay.classList.add('hidden');
                            showMap();
                        });
                    }, { once: true });
                });
            }
        }

        // ==================== 顯示地圖 ====================
        function showMap() {
            console.log('顯示地圖');
            mapScene.classList.remove('hidden');
            videoScene.classList.add('hidden');
            resultScene.classList.add('hidden');
            introScene.style.display = 'none';
            
            // 嘗試播放背景音樂
            if (!bgmPlayed) {
                tryPlayBGM();
            }
        }

        // ==================== 播放島嶼劇情 ====================
        function playScene(islandName) {
            if (isTransitioning) {
                console.log('正在轉場中，忽略點擊');
                return;
            }

            console.log('準備播放島嶼:', islandName);
            isTransitioning = true;
            currentIsland = islandName;

            // 顯示載入畫面
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = '載入中...';
            loadingOverlay.style.cursor = 'default';

            // 隱藏地圖
            mapScene.classList.add('hidden');

            // 設定過場影片路徑
            const videoPath = `video_${islandName}.mp4`;
            
            // 清空之前的影片
            videoPlayer.src = '';
            videoPlayer.load();
            
            // 設定新的影片
            videoPlayer.src = videoPath;
            videoPlayer.load();

            // 監聽影片載入狀態
            let canPlayTriggered = false;
            
            const onCanPlay = function() {
                if (canPlayTriggered) return;
                canPlayTriggered = true;
                
                console.log('過場影片準備完成');
                
                // 隱藏載入畫面
                loadingOverlay.classList.add('hidden');
                
                // 顯示影片場景
                videoScene.classList.remove('hidden');
                
                // 播放影片
                const playPromise = videoPlayer.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('過場影片開始播放');
                        // 正常速度播放
                        videoPlayer.playbackRate = 1.0;
                        
                        // 同時預載背景循環影片
                        preloadBackgroundVideo(islandName);
                        
                    }).catch(error => {
                        console.error('過場影片播放失敗:', error);
                        alert('影片播放失敗，請重試');
                        resetMap();
                    });
                }
                
                // 移除監聽器
                videoPlayer.removeEventListener('canplaythrough', onCanPlay);
            };

            videoPlayer.addEventListener('canplaythrough', onCanPlay);

            // 設定超時保護
            setTimeout(() => {
                if (!canPlayTriggered) {
                    console.log('載入超時，嘗試強制播放');
                    onCanPlay();
                }
            }, 5000);
        }

        // ==================== 預載背景循環影片 ====================
        function preloadBackgroundVideo(islandName) {
            console.log('預載背景循環影片:', islandName);
            const loopPath = `loop_${islandName}.mp4`;
            
            bgVideo.src = loopPath;
            bgVideo.load();
            
            bgVideo.addEventListener('canplaythrough', function() {
                console.log('背景影片已準備完成');
            }, { once: true });
        }

        // ==================== 監聽過場影片結束 ====================
        videoPlayer.addEventListener('ended', function() {
            console.log('過場影片播放完畢，顯示結果頁');
            showResult();
        });

        // ==================== 顯示結果頁 ====================
        function showResult() {
            // 隱藏過場影片
            videoScene.classList.add('hidden');
            
            // 顯示結果頁
            resultScene.classList.remove('hidden');
            
            // 播放背景循環影片
            const playPromise = bgVideo.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('背景循環影片開始播放');
                    isTransitioning = false;
                }).catch(error => {
                    console.log('背景影片播放失敗:', error);
                    // 即使播放失敗，也要解除鎖定
                    isTransitioning = false;
                });
            } else {
                isTransitioning = false;
            }
        }

        // ==================== 回到地圖 ====================
        function resetMap() {
            console.log('回到地圖');
            
            // 停止所有影片
            videoPlayer.pause();
            videoPlayer.src = '';
            videoPlayer.load();
            
            bgVideo.pause();
            bgVideo.src = '';
            bgVideo.load();
            
            // 重置狀態
            currentIsland = '';
            isTransitioning = false;
            
            // 顯示地圖
            showMap();
        }

        // ==================== 語言切換 ====================
        function toggleLanguage() {
            console.log('切換語言');
            
            const imgLang = document.getElementById('img-lang');
            const imgCompany = document.getElementById('img-company');
            const imgBack = document.getElementById('img-back');
            const islands = ['dragon', 'volcano', 'park', 'castle', 'temple'];

            if (currentLang === 'cn') {
                // 切換成英文
                currentLang = 'en';
                imgLang.src = 'lang_to_cn.png';
                imgCompany.src = 'btn_company_en.png';
                imgBack.src = 'btn_back_en.png';
                
                islands.forEach(name => {
                    const btn = document.getElementById(`btn-${name}`);
                    btn.style.backgroundImage = `url('icon_${name}_en.png')`;
                });
                
                console.log('已切換為英文');
            } else {
                // 切換成中文
                currentLang = 'cn';
                imgLang.src = 'lang_to_en.png';
                imgCompany.src = 'btn_company.png';
                imgBack.src = 'btn_back.png';
                
                islands.forEach(name => {
                    const btn = document.getElementById(`btn-${name}`);
                    btn.style.backgroundImage = `url('icon_${name}.png')`;
                });
                
                console.log('已切換為中文');
            }
        }

        // ==================== 背景音樂控制 ====================
        function tryPlayBGM() {
            const bgm = document.getElementById('map-bgm');
            
            if (bgm.paused && !mapScene.classList.contains('hidden')) {
                bgm.play().then(() => {
                    console.log('背景音樂開始播放');
                    bgmPlayed = true;
                }).catch(error => {
                    console.log('背景音樂需要用戶互動:', error);
                });
            }
        }

        // 用戶首次互動時嘗試播放音樂
        document.addEventListener('click', function() {
            if (!bgmPlayed) {
                tryPlayBGM();
            }
        }, { once: true });

        // ==================== 防止頁面滾動 ====================
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });

        // ==================== 錯誤處理 ====================
        window.addEventListener('error', function(e) {
            console.error('發生錯誤:', e);
        });

        videoPlayer.addEventListener('error', function(e) {
            // 只在有實際影片路徑時才顯示錯誤（避免清空時觸發）
            if (videoPlayer.src && videoPlayer.src !== '' && videoPlayer.src !== window.location.href) {
                console.error('影片載入錯誤:', e);
                console.error('錯誤的影片路徑:', videoPlayer.src);
                console.error('當前島嶼:', currentIsland);
                console.error('networkState:', videoPlayer.networkState);
                console.error('readyState:', videoPlayer.readyState);
                
                // 只在轉場過程中才顯示錯誤訊息
                if (isTransitioning && currentIsland) {
                    let errorMsg = '影片載入失敗\n';
                    errorMsg += '檔案: video_' + currentIsland + '.mp4\n';
                    errorMsg += '請確認:\n';
                    errorMsg += '1. 檔案是否存在\n';
                    errorMsg += '2. 檔案名稱是否正確\n';
                    errorMsg += '3. 影片格式是否為 MP4 (H.264)\n';
                    errorMsg += '4. 檔案大小是否過大';
                    
                    alert(errorMsg);
                    resetMap();
                }
            }
        });

        bgVideo.addEventListener('error', function(e) {
            // 只記錄背景影片錯誤，不顯示彈窗
            if (bgVideo.src && bgVideo.src !== '' && bgVideo.src !== window.location.href) {
                console.error('背景影片載入錯誤:', e);
                console.error('檔案:', bgVideo.src);
            }
        });

        introVideo.addEventListener('error', function(e) {
            // 片頭影片載入失敗，直接跳過
            if (introVideo.src && introVideo.src !== '') {
                console.error('片頭影片載入失敗，直接進入地圖', e);
                introScene.style.display = 'none';
                loadingOverlay.classList.add('hidden');
                showMap();
            }
        });

        // ==================== Console 日誌 ====================
        console.log('=== 奇幻島嶼探險 系統初始化完成 ===');
        console.log('公司網址:', companyUrl);
        console.log('當前語言:', currentLang);
    </script>
</body>
</html>
